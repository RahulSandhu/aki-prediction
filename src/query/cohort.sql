WITH COHORT AS (
    SELECT 
        di.SUBJECT_ID,
        di.HADM_ID,
        a.ADMITTIME,
        p.GENDER, 
        (
            SELECT 
                a2.ETHNICITY 
            FROM 
                ADMISSIONS a2 
            WHERE 
                a2.SUBJECT_ID = p.SUBJECT_ID 
            ORDER BY 
                a2.ADMITTIME DESC 
            LIMIT 1
        ) AS ETHNICITY,
        TIMESTAMPDIFF(YEAR, p.DOB, a.ADMITTIME) AS AGE_YEARS
    FROM 
        DIAGNOSES_ICD di
    JOIN 
        ADMISSIONS a ON di.HADM_ID = a.HADM_ID
    JOIN 
        PATIENTS p ON di.SUBJECT_ID = p.SUBJECT_ID
    WHERE 
        di.ICD9_CODE IN ('99591', '99592', '78552') -- Sepsis ICD-9 codes
        AND TIMESTAMPDIFF(YEAR, p.DOB, a.ADMITTIME) BETWEEN 18 AND 89 -- Age restriction
        AND TIMESTAMPDIFF(HOUR, a.ADMITTIME, a.DISCHTIME) >= 48 -- Length of stay restriction
    GROUP BY 
        di.SUBJECT_ID, di.HADM_ID
),
COMORBIDITIES AS (
    SELECT 
        di.SUBJECT_ID,
        MAX(CASE WHEN di.ICD9_CODE LIKE '250%' THEN 1 ELSE 0 END) AS DM2, -- Type 2 Diabetes Mellitus
        MAX(CASE WHEN di.ICD9_CODE LIKE '414%' THEN 1 ELSE 0 END) AS CAD, -- Coronary Artery Disease 
        MAX(CASE 
                WHEN di.ICD9_CODE LIKE '582%' 
                     OR di.ICD9_CODE LIKE '585%' 
                     OR di.ICD9_CODE LIKE '587%' 
                     OR di.ICD9_CODE LIKE '588%' THEN 1 
                ELSE 0 
            END) AS CKD, -- Chronic Kidney Disease
        MAX(CASE WHEN di.ICD9_CODE LIKE '401%' THEN 1 ELSE 0 END) AS HYP, -- Hypertension
        MAX(CASE WHEN di.ICD9_CODE LIKE '584%' THEN 1 ELSE 0 END) AS AKI -- Acute Kidney Disease
    FROM 
        DIAGNOSES_ICD di
    JOIN 
        COHORT ch ON di.SUBJECT_ID = ch.SUBJECT_ID 
    GROUP BY 
        di.SUBJECT_ID
),
LAB_FEATURES AS (
    SELECT 
        le.SUBJECT_ID,
        le.HADM_ID,
        -- Anion Gap (mmol/L)
        MAX(CASE WHEN le.ITEMID = 50868 THEN le.VALUENUM END) AS MAX_ANION_GAP,
        MIN(CASE WHEN le.ITEMID = 50868 THEN le.VALUENUM END) AS MIN_ANION_GAP,
        -- Albumin (g/dL)
        MAX(CASE WHEN le.ITEMID = 50862 THEN le.VALUENUM END) AS MAX_ALBUMIN,
        MIN(CASE WHEN le.ITEMID = 50862 THEN le.VALUENUM END) AS MIN_ALBUMIN,
        -- Bilirubin (mg/dL)
        MAX(CASE WHEN le.ITEMID = 50885 THEN le.VALUENUM END) AS MAX_BILIRUBIN,
        MIN(CASE WHEN le.ITEMID = 50885 THEN le.VALUENUM END) AS MIN_BILIRUBIN,
        -- Creatinine (mg/dL)
        MAX(CASE WHEN le.ITEMID = 50912 THEN le.VALUENUM END) AS MAX_CREATININE,
        MIN(CASE WHEN le.ITEMID = 50912 THEN le.VALUENUM END) AS MIN_CREATININE,
        -- Chloride (mmol/L)
        MAX(CASE WHEN le.ITEMID IN (50806, 50902) THEN le.VALUENUM END) AS MAX_CHLORIDE,
        MIN(CASE WHEN le.ITEMID IN (50806, 50902) THEN le.VALUENUM END) AS MIN_CHLORIDE,
        -- Glucose (mg/dL)
        MAX(CASE WHEN le.ITEMID IN (50809, 50931) THEN le.VALUENUM END) AS MAX_GLUCOSE,
        MIN(CASE WHEN le.ITEMID IN (50809, 50931) THEN le.VALUENUM END) AS MIN_GLUCOSE,
        -- Hematocrit (%)
        MAX(CASE WHEN le.ITEMID IN (50810, 51221) THEN le.VALUENUM END) AS MAX_HEMATOCRIT,
        MIN(CASE WHEN le.ITEMID IN (50810, 51221) THEN le.VALUENUM END) AS MIN_HEMATOCRIT,
        -- Hemoglobin (g/dL)
        MAX(CASE WHEN le.ITEMID IN (50811, 51222) THEN le.VALUENUM END) AS MAX_HEMOGLOBIN,
        MIN(CASE WHEN le.ITEMID IN (50811, 51222) THEN le.VALUENUM END) AS MIN_HEMOGLOBIN,
        -- Lactate (mmol/L)
        MAX(CASE WHEN le.ITEMID = 50813 THEN le.VALUENUM END) AS MAX_LACTATE,
        MIN(CASE WHEN le.ITEMID = 50813 THEN le.VALUENUM END) AS MIN_LACTATE,
        -- Platelet (10^3/μL)
        MAX(CASE WHEN le.ITEMID = 51265 THEN le.VALUENUM END) AS MAX_PLATELET,
        MIN(CASE WHEN le.ITEMID = 51265 THEN le.VALUENUM END) AS MIN_PLATELET,
        -- Potassium (mmol/L)
        MAX(CASE WHEN le.ITEMID IN (50822, 50971) THEN le.VALUENUM END) AS MAX_POTASSIUM,
        MIN(CASE WHEN le.ITEMID IN (50822, 50971) THEN le.VALUENUM END) AS MIN_POTASSIUM,
        -- Sodium (mmol/L)
        MAX(CASE WHEN le.ITEMID IN (50824, 50983) THEN le.VALUENUM END) AS MAX_SODIUM,
        MIN(CASE WHEN le.ITEMID IN (50824, 50983) THEN le.VALUENUM END) AS MIN_SODIUM,
        -- Blood Urea Nitrogen (BUN) (mg/dL)
        MAX(CASE WHEN le.ITEMID = 51006 THEN le.VALUENUM END) AS MAX_BUN,
        MIN(CASE WHEN le.ITEMID = 51006 THEN le.VALUENUM END) AS MIN_BUN,
        -- Partial Thromboplastin Time (PTT) (seconds)
        MAX(CASE WHEN le.ITEMID = 51275 THEN le.VALUENUM END) AS MAX_PTT,
        MIN(CASE WHEN le.ITEMID = 51275 THEN le.VALUENUM END) AS MIN_PTT,
        -- International Normalized Ratio (INR) (ratio)
        MAX(CASE WHEN le.ITEMID = 51237 THEN le.VALUENUM END) AS MAX_INR,
        MIN(CASE WHEN le.ITEMID = 51237 THEN le.VALUENUM END) AS MIN_INR,
        -- Estimated GFR (mL/min/1.73m²)
        MAX(CASE WHEN le.ITEMID = 50920 THEN le.VALUENUM END) AS MAX_EGFR,
        MIN(CASE WHEN le.ITEMID = 50920 THEN le.VALUENUM END) AS MIN_EGFR
    FROM 
        LABEVENTS le
    JOIN 
        COHORT ch ON le.SUBJECT_ID = ch.SUBJECT_ID AND le.HADM_ID = ch.HADM_ID
    WHERE 
        le.ITEMID IN (
            50868, 50862, 50885, 50912, 50806, 50902, 50809, 50931, 50810, 51221, 
            50811, 51222, 50813, 51265, 50822, 50971, 50824, 50983, 51006, 51275, 
            51237, 50920
        )
        AND le.CHARTTIME BETWEEN ch.ADMITTIME AND DATE_ADD(ch.ADMITTIME, INTERVAL 24 HOUR) -- First 24 hours
        AND le.VALUENUM > 0
    GROUP BY 
        le.SUBJECT_ID, le.HADM_ID
),
CHART_FEATURES AS (
    SELECT 
        c.SUBJECT_ID,
        c.HADM_ID,
        -- Heart Rate (BPM)
        MAX(CASE WHEN c.ITEMID IN (211, 220045) THEN c.VALUENUM END) AS MAX_HR,
        MIN(CASE WHEN c.ITEMID IN (211, 220045) THEN c.VALUENUM END) AS MIN_HR,
        -- Systolic Blood Pressure (mmHg)
        MAX(CASE WHEN c.ITEMID IN (51, 442, 455, 6701, 220179, 220050) THEN c.VALUENUM END) AS MAX_SBP,
        MIN(CASE WHEN c.ITEMID IN (51, 442, 455, 6701, 220179, 220050) THEN c.VALUENUM END) AS MIN_SBP,
        -- Diastolic Blood Pressure (mmHg)
        MAX(CASE WHEN c.ITEMID IN (8368, 8440, 8441, 8555, 220180, 220051) THEN c.VALUENUM END) AS MAX_DBP,
        MIN(CASE WHEN c.ITEMID IN (8368, 8440, 8441, 8555, 220180, 220051) THEN c.VALUENUM END) AS MIN_DBP,
        -- Temperature (Celsius)
        MAX(CASE 
            WHEN c.ITEMID IN (223762, 676) THEN c.VALUENUM 
            WHEN c.ITEMID IN (223761, 678) THEN (c.VALUENUM - 32) * 5 / 9 -- Fahrenheit to Celsius
        END) AS MAX_TEMP,
        MIN(CASE 
            WHEN c.ITEMID IN (223762, 676) THEN c.VALUENUM 
            WHEN c.ITEMID IN (223761, 678) THEN (c.VALUENUM - 32) * 5 / 9 -- Fahrenheit to Celsius
        END) AS MIN_TEMP,
        -- Oxygen Saturation (%)
        MAX(CASE WHEN c.ITEMID IN (646, 220277) THEN c.VALUENUM END) AS MAX_SPO2,
        MIN(CASE WHEN c.ITEMID IN (646, 220277) THEN c.VALUENUM END) AS MIN_SPO2,
        -- Weight (Kg)
        MAX(CASE 
            WHEN c.ITEMID IN (226512, 3580, 3693) THEN c.VALUENUM 
            WHEN c.ITEMID = 226531 THEN c.VALUENUM * 0.453592 -- pounds to kg
            WHEN c.ITEMID = 3582 THEN c.VALUENUM * 0.0283495 -- ounces to kg
        END) AS MAX_WEIGHT,
        MIN(CASE 
            WHEN c.ITEMID IN (226512, 3580, 3693) THEN c.VALUENUM 
            WHEN c.ITEMID = 226531 THEN c.VALUENUM * 0.453592 -- pounds to kg
            WHEN c.ITEMID = 3582 THEN c.VALUENUM * 0.0283495 -- ounces to kg
        END) AS MIN_WEIGHT,
        -- Height (cm)
        MAX(CASE 
            WHEN c.ITEMID IN (226730, 226707) THEN c.VALUENUM 
            WHEN c.ITEMID = 1394 THEN c.VALUENUM * 2.54 -- inches to cm
        END) AS MAX_HEIGHT,
        MIN(CASE 
            WHEN c.ITEMID IN (226730, 226707) THEN c.VALUENUM 
            WHEN c.ITEMID = 1394 THEN c.VALUENUM * 2.54 -- inches to cm
        END) AS MIN_HEIGHT,
       	-- Mechanical Ventilation
        MAX(CASE WHEN c.ITEMID = 226260 THEN 1 ELSE 0 END) AS MECHANICAL_VENTILATION,
        -- Vasopressor
        MAX(CASE WHEN c.ITEMID IN (30051, 222315) THEN 1 ELSE 0 END) AS VASOPRESSOR
    FROM 
        CHARTEVENTS c 
    JOIN 
        COHORT ch ON c.SUBJECT_ID = ch.SUBJECT_ID AND c.HADM_ID = ch.HADM_ID
    WHERE 
        c.ITEMID IN (
            211, 220045, 51, 442, 455, 6701, 220179, 220050, 8368, 8440, 8441, 8555, 220180, 
            220051, 223762, 676, 223761, 678, 646, 220277, 226512, 3580, 3581, 3582, 224639, 
            226512, 226531, 3693, 226730, 226707, 1394, 226260, 30051, 222315
        )
        AND c.CHARTTIME BETWEEN ch.ADMITTIME AND DATE_ADD(ch.ADMITTIME, INTERVAL 24 HOUR) -- First 24 hours
        AND c.VALUENUM > 0
    GROUP BY 
        c.SUBJECT_ID, c.HADM_ID
)
SELECT 
    ch.SUBJECT_ID,
    ch.HADM_ID,
    ch.GENDER,
    ch.ETHNICITY,
    ch.AGE_YEARS,
    co.DM2,
    co.CAD,
    co.CKD,
    co.HYP,
    co.AKI,
    CASE WHEN lf.MAX_CREATININE <= 150 THEN lf.MAX_CREATININE ELSE NULL END AS MAX_CREATININE,
    CASE WHEN lf.MIN_CREATININE <= 150 THEN lf.MIN_CREATININE ELSE NULL END AS MIN_CREATININE,
    CASE WHEN lf.MAX_ALBUMIN <= 10 THEN lf.MAX_ALBUMIN ELSE NULL END AS MAX_ALBUMIN,
    CASE WHEN lf.MIN_ALBUMIN <= 10 THEN lf.MIN_ALBUMIN ELSE NULL END AS MIN_ALBUMIN,
    CASE WHEN lf.MAX_ANION_GAP <= 10000 THEN lf.MAX_ANION_GAP ELSE NULL END AS MAX_ANION_GAP,
    CASE WHEN lf.MIN_ANION_GAP <= 10000 THEN lf.MIN_ANION_GAP ELSE NULL END AS MIN_ANION_GAP,
    CASE WHEN lf.MAX_BILIRUBIN <= 150 THEN lf.MAX_BILIRUBIN ELSE NULL END AS MAX_BILIRUBIN,
    CASE WHEN lf.MIN_BILIRUBIN <= 150 THEN lf.MIN_BILIRUBIN ELSE NULL END AS MIN_BILIRUBIN,
    CASE WHEN lf.MAX_CHLORIDE <= 10000 THEN lf.MAX_CHLORIDE ELSE NULL END AS MAX_CHLORIDE,
    CASE WHEN lf.MIN_CHLORIDE <= 10000 THEN lf.MIN_CHLORIDE ELSE NULL END AS MIN_CHLORIDE,
    CASE WHEN lf.MAX_GLUCOSE <= 10000 THEN lf.MAX_GLUCOSE ELSE NULL END AS MAX_GLUCOSE,
    CASE WHEN lf.MIN_GLUCOSE <= 10000 THEN lf.MIN_GLUCOSE ELSE NULL END AS MIN_GLUCOSE,
    CASE WHEN lf.MAX_LACTATE <= 50 THEN lf.MAX_LACTATE ELSE NULL END AS MAX_LACTATE,
    CASE WHEN lf.MIN_LACTATE <= 50 THEN lf.MIN_LACTATE ELSE NULL END AS MIN_LACTATE,
    CASE WHEN lf.MAX_PLATELET <= 10000 THEN lf.MAX_PLATELET ELSE NULL END AS MAX_PLATELET,
    CASE WHEN lf.MIN_PLATELET <= 10000 THEN lf.MIN_PLATELET ELSE NULL END AS MIN_PLATELET,
    CASE WHEN lf.MAX_POTASSIUM <= 30 THEN lf.MAX_POTASSIUM ELSE NULL END AS MAX_POTASSIUM,
    CASE WHEN lf.MIN_POTASSIUM <= 30 THEN lf.MIN_POTASSIUM ELSE NULL END AS MIN_POTASSIUM,
    CASE WHEN lf.MAX_SODIUM <= 200 THEN lf.MAX_SODIUM ELSE NULL END AS MAX_SODIUM,
    CASE WHEN lf.MIN_SODIUM <= 200 THEN lf.MIN_SODIUM ELSE NULL END AS MIN_SODIUM,
    CASE WHEN lf.MAX_HEMATOCRIT <= 100 THEN lf.MAX_HEMATOCRIT ELSE NULL END AS MAX_HEMATOCRIT,
    CASE WHEN lf.MIN_HEMATOCRIT <= 100 THEN lf.MIN_HEMATOCRIT ELSE NULL END AS MIN_HEMATOCRIT,
    CASE WHEN lf.MAX_HEMOGLOBIN <= 50 THEN lf.MAX_HEMOGLOBIN ELSE NULL END AS MAX_HEMOGLOBIN,
    CASE WHEN lf.MIN_HEMOGLOBIN <= 50 THEN lf.MIN_HEMOGLOBIN ELSE NULL END AS MIN_HEMOGLOBIN,
    CASE WHEN lf.MAX_EGFR IS NOT NULL THEN lf.MAX_EGFR ELSE NULL END AS MAX_EGFR,
    CASE WHEN lf.MIN_EGFR IS NOT NULL THEN lf.MIN_EGFR ELSE NULL END AS MIN_EGFR,
    CASE WHEN lf.MAX_BUN <= 300 THEN lf.MAX_BUN ELSE NULL END AS MAX_BUN,
    CASE WHEN lf.MIN_BUN <= 300 THEN lf.MIN_BUN ELSE NULL END AS MIN_BUN,
    CASE WHEN lf.MAX_PTT <= 150 THEN lf.MAX_PTT ELSE NULL END AS MAX_PTT,
    CASE WHEN lf.MIN_PTT <= 150 THEN lf.MIN_PTT ELSE NULL END AS MIN_PTT,
    CASE WHEN lf.MAX_INR <= 50 THEN lf.MAX_INR ELSE NULL END AS MAX_INR,
    CASE WHEN lf.MIN_INR <= 50 THEN lf.MIN_INR ELSE NULL END AS MIN_INR,
    CASE WHEN cf.MAX_HR BETWEEN 40 AND 250 THEN cf.MAX_HR ELSE NULL END AS MAX_HR,
    CASE WHEN cf.MIN_HR BETWEEN 40 AND 250 THEN cf.MIN_HR ELSE NULL END AS MIN_HR,
    CASE WHEN cf.MAX_SBP BETWEEN 50 AND 250 THEN cf.MAX_SBP ELSE NULL END AS MAX_SBP,
    CASE WHEN cf.MIN_SBP BETWEEN 50 AND 250 THEN cf.MIN_SBP ELSE NULL END AS MIN_SBP,
    CASE WHEN cf.MAX_DBP BETWEEN 20 AND 200 THEN cf.MAX_DBP ELSE NULL END AS MAX_DBP,
    CASE WHEN cf.MIN_DBP BETWEEN 20 AND 200 THEN cf.MIN_DBP ELSE NULL END AS MIN_DBP,
    CASE WHEN cf.MAX_TEMP BETWEEN 30 AND 45 THEN cf.MAX_TEMP ELSE NULL END AS MAX_TEMP,
    CASE WHEN cf.MIN_TEMP BETWEEN 30 AND 45 THEN cf.MIN_TEMP ELSE NULL END AS MIN_TEMP,
    CASE WHEN cf.MAX_SPO2 BETWEEN 70 AND 100 THEN cf.MAX_SPO2 ELSE NULL END AS MAX_SPO2,
    CASE WHEN cf.MIN_SPO2 BETWEEN 70 AND 100 THEN cf.MIN_SPO2 ELSE NULL END AS MIN_SPO2,
    cf.MAX_WEIGHT,
    cf.MIN_WEIGHT,
    cf.MAX_HEIGHT,
    cf.MIN_HEIGHT,
    cf.MECHANICAL_VENTILATION,
    cf.VASOPRESSOR
FROM 
    COHORT ch
JOIN 
	COMORBIDITIES co ON ch.SUBJECT_ID = co.SUBJECT_ID
JOIN 
    LAB_FEATURES lf ON ch.SUBJECT_ID = lf.SUBJECT_ID AND ch.HADM_ID = lf.HADM_ID
JOIN 
    CHART_FEATURES cf ON lf.SUBJECT_ID = cf.SUBJECT_ID AND lf.HADM_ID = cf.HADM_ID
GROUP BY 
	ch.SUBJECT_ID, ch.HADM_ID;
